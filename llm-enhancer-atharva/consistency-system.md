# Consistency System

## Overview

We use a **dual consistency approach** to ensure all images and videos share the same visual universe:

1. **Text-Based Markers** - High-level style guidance
2. **Visual Reference Images** - Pixel-level consistency

## Text-Based Consistency Markers

### What Are They?

Consistency markers are style attributes generated by the LLM that are applied to ALL prompts:

```python
consistency_markers = {
    "style": "dynamic modern minimalist",
    "color_palette": "vibrant primary colors",
    "lighting": "bright natural daylight",
    "composition": "dynamic angles with rule of thirds",
    "mood": "energetic optimistic"
}
```

### How They're Generated

1. **Storyboard Planner** generates markers as part of the storyboard plan
2. Stored in `Generation.coherence_settings["consistency_markers"]`
3. Applied to all image and video prompts

### How They're Applied

```python
def _enhance_prompt_with_markers(base_prompt, consistency_markers):
    # Example:
    # Base: "A person jogging in a park"
    # Enhanced: "A person jogging in a park. Style: dynamic modern minimalist, Color palette: vibrant primary colors, Lighting: bright natural daylight, Composition: dynamic angles with rule of thirds, Mood: energetic optimistic"
    return enhanced_prompt
```

## Visual Reference Images

### Sequential Image Chain

Images are generated sequentially, with each image using the previous one as reference:

```
Image 1: Prompt + Markers (no reference)
    ↓
Image 2: Prompt + Markers + Image 1 reference
    ↓
Image 3: Prompt + Markers + Image 2 reference
    ↓
Image 4: Prompt + Markers + Image 3 reference
```

### Why Sequential?

- **Character Consistency**: Same person/product across images
- **Style Consistency**: Visual style carries forward
- **Color Consistency**: Palette remains consistent
- **Nano Banana Feature**: Supports character/style consistency via reference images

### Implementation

```python
# Image generation with reference
await generate_image(
    prompt=detailed_prompt,
    consistency_markers=markers,
    reference_image_path=previous_image_path,  # Previous image
    ...
)
```

## Video Generation Consistency

### Using Generated Reference Images

Each video uses its corresponding generated reference image:

```
Video 1: Detailed Prompt + Markers + Image 1 reference
Video 2: Detailed Prompt + Markers + Image 2 reference
Video 3: Detailed Prompt + Markers + Image 3 reference
Video 4: Detailed Prompt + Markers + Image 4 reference
```

### Why This Works

1. **Detailed Prompts**: Rich descriptions ensure quality
2. **Consistency Markers**: Text-based style guidance
3. **Reference Images**: Visual consistency from generated images
4. **Same Universe**: All videos share the same visual style

## Complete Consistency Flow

```
Storyboard Plan
    ├─→ Consistency Markers (text)
    └─→ Detailed Prompts (4 scenes)
            ↓
    ┌───────┴───────┐
    ↓               ↓
Image Gen      Video Gen
(Sequential)   (Parallel)
    ↓               ↓
Image 1 ───────→ Video 1 (uses Image 1)
    ↓               ↓
Image 2 ───────→ Video 2 (uses Image 2)
    ↓               ↓
Image 3 ───────→ Video 3 (uses Image 3)
    ↓               ↓
Image 4 ───────→ Video 4 (uses Image 4)
```

## Benefits

1. **Visual Cohesion**: All content shares same style, colors, lighting
2. **Character Consistency**: Same person/product across scenes
3. **Universe Consistency**: Scenes feel like same world
4. **Brand Consistency**: Maintains visual identity
5. **Quality**: Detailed prompts + references = better results

## Storage

- **Markers**: Stored in `Generation.coherence_settings["consistency_markers"]`
- **Storyboard Plan**: Stored in `Generation.coherence_settings["storyboard_plan"]`
- **Reference Images**: Stored in `output/temp/images/{generation_id}/`
- **Reference Image Paths**: Stored in `Scene.reference_image_path`

