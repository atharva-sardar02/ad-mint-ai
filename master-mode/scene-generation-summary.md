# Scene Generation Implementation Summary

## Overview

Implemented a three-agent system to generate detailed, production-ready scenes from the story generated by the Story Director and Story Critic.

## Agents

### 1. Scene Writer (`scene_writer.py`)
- **Role**: Writes detailed scene descriptions with visual specifications
- **Output**: 150-250 word scene descriptions including:
  - Visual description (characters, products, setting)
  - Cinematography specs (camera angles, movements, lenses)
  - Start frame description (scene opening)
  - End frame description (scene closing, designed to transition to next scene)
  - Lighting and mood
  - Continuity notes (location persistence, narrative flow)
  - Audio Specifications (music mood, voiceover line)
- **Context**: Receives full story + scene number + previously written scenes
- **Feedback**: Incorporates feedback from Scene Critic and Scene Cohesor

### 2. Scene Critic (`scene_critic.py`)
- **Role**: Evaluates individual scenes for quality and production readiness
- **Evaluation Criteria** (100-point scale):
  1. Visual Detail Sufficiency (30 pts): Detailed enough for video generation?
  2. Cinematographic Specifications (20 pts): Complete camera/lighting specs?
  3. Subject Consistency (20 pts): Maintains identity from story?
  4. Continuity (15 pts): Connects to previous/next scenes?
  5. Scene Quality (10 pts): Engaging, well-paced?
  6. Production Readiness (5 pts): Unambiguous?
- **Approval**: Score >= 85 AND all critical elements present
- **Output**: `SceneCritique` with approval status, score, critique, strengths, improvements, priority fixes

### 3. Scene Cohesor (`scene_cohesor.py`)
- **Role**: Ensures seamless flow across all scenes
- **Analysis**:
  - **Pairwise Transitions**: Scene 1→2, 2→3, etc. (end frame matches start frame context)
  - **Overall Cohesion**: Subject consistency, visual style, color, lighting, narrative flow
- **Approval**: Overall cohesion score >= 80
- **Output**: `CohesionAnalysis` with overall score, pairwise analysis, global issues, scene-specific feedback

## Workflow

The scene generation process is orchestrated by `scene_generator.py`:

### Phase 1: Sequential Scene Generation
For each scene (1 to N):
1. **Scene Writer** writes the scene
2. **Scene Critic** evaluates the scene
3. If approved (score >= 85): Move to next scene
4. If not approved: Scene Writer revises based on feedback
5. Repeat up to 3 iterations per scene

### Phase 2: Cohesion Review
After all scenes are written:
1. **Scene Cohesor** analyzes all scenes:
   - Checks pairwise transitions (1→2, 2→3, etc.)
   - Checks overall cohesion (subject consistency, visual style, etc.)
2. If cohesion score >= 80: Complete
3. If not: Scene Writer revises scenes based on Scene Cohesor feedback
4. Repeat cohesion review up to 2 iterations

## Integration

### Backend API
- **Endpoint**: `POST /api/master-mode/generate-story`
- **Parameter**: `generate_scenes=true` (default)
- **Flow**:
  1. Generate story using Story Director + Story Critic
  2. If `generate_scenes=true`: Call `generate_scenes_from_story()`
  3. Return story + scenes + conversation history

### Frontend Display
- **Scenes Overview**: Total scenes, cohesion score, total iterations
- **Individual Scenes**: Scene number, content, iterations, approval status, score
- **Cohesion Analysis**: 
  - Pairwise transitions with scores and issues
  - Global issues
  - Scene-specific feedback
- **Scene Agent Conversation**: Collapsible view showing Writer (blue), Critic (purple), Cohesor (green) messages

## File Structure

```
backend/app/services/master_mode/
├── __init__.py                 # Exports
├── schemas.py                  # Pydantic models
├── story_director.py           # Story Director agent
├── story_critic.py             # Story Critic agent
├── story_generator.py          # Story generation orchestrator
├── scene_writer.py             # Scene Writer agent (NEW)
├── scene_critic.py             # Scene Critic agent (NEW)
├── scene_cohesor.py            # Scene Cohesor agent (NEW)
└── scene_generator.py          # Scene generation orchestrator (NEW)

frontend/src/routes/
└── MasterMode.tsx              # UI for Master Mode (UPDATED)

backend/app/api/routes/
└── master_mode.py              # API endpoints (UPDATED)
```

## Schemas

### SceneCritique
- `approval_status`: "approved" | "needs_revision"
- `overall_score`: 0-100
- `critique`: Detailed feedback
- `strengths`: List of strengths
- `improvements`: List of improvements needed
- `priority_fixes`: List of priority fixes

### PairwiseTransitionAnalysis
- `from_scene`: Scene number
- `to_scene`: Scene number
- `transition_score`: 0-100
- `issues`: List of issues
- `recommendations`: List of recommendations

### CohesionAnalysis
- `overall_cohesion_score`: 0-100
- `pair_wise_analysis`: List of `PairwiseTransitionAnalysis`
- `global_issues`: List of global issues
- `scene_specific_feedback`: Dict[scene_number → feedback]
- `consistency_issues`: List of consistency issues
- `overall_recommendations`: List of recommendations

### SceneData
- `scene_number`: 1 to N
- `content`: Markdown scene description
- `iterations`: Number of iterations
- `approved`: Boolean
- `final_critique`: `SceneCritique`

### ScenesGenerationResult
- `original_story`: Full story from Story Director
- `total_scenes`: Number of scenes
- `scenes`: List of `SceneData`
- `cohesion_score`: Overall cohesion score
- `cohesion_analysis`: `CohesionAnalysis`
- `conversation_history`: List of agent messages
- `total_iterations`: Total iterations across all scenes

## Trace Support

For debugging, `scene_generator.py` supports trace directory:
- `story.md`: Original story
- `scene_{N}_iteration_{I}_draft.md`: Scene drafts
- `scene_{N}_iteration_{I}_critique.json`: Critiques
- `scene_{N}_cohesor_revision_{I}.md`: Cohesor-driven revisions
- `cohesion_iteration_{I}_analysis.json`: Cohesion analyses
- `final_scenes.md`: Final combined scenes
- `scene_generation_summary.json`: Summary stats

## Key Features

1. **Context Awareness**: Each scene receives the full story + previously written scenes
2. **Seamless Transitions**: End frames designed to flow into start frames
3. **Production-Ready**: Detailed visual specs, camera specs, lighting, mood
4. **Quality Control**: Multi-criteria evaluation (100-point scale)
5. **Cohesion Enforcement**: Pairwise and global cohesion checks
6. **Iterative Refinement**: Up to 3 iterations per scene + 2 cohesion iterations
7. **Traceability**: Full conversation history and optional trace files
8. **Extensibility**: Easy to add more agents or criteria

## Next Steps

- Integrate with video generation pipeline
- Use scene content to generate video prompts
- Generate videos in parallel for each scene
- Stitch videos with transitions based on cohesion analysis

