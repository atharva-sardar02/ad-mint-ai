name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: us-east-1
  S3_FRONTEND_BUCKET: ad-mint-ai-frontend
  EC2_DEPLOYMENT_PATH: /var/www/ad-mint-ai
  EC2_HOST: 44.210.144.149
  API_BASE_URL: http://44.210.144.149

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ env.API_BASE_URL }}
        run: |
          npm ci
          npm run build

      - name: Deploy frontend to S3
        run: |
          aws s3 sync frontend/dist/ s3://${{ env.S3_FRONTEND_BUCKET }}/ --delete
          echo "‚úÖ Frontend deployed to S3"

      - name: Verify frontend deployment
        run: |
          # Check if index.html exists in S3
          if aws s3 ls s3://${{ env.S3_FRONTEND_BUCKET }}/index.html > /dev/null 2>&1; then
            echo "‚úÖ Frontend deployment verified"
          else
            echo "‚ùå Frontend deployment verification failed"
            exit 1
          fi

      - name: Backup current backend deployment
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ env.EC2_HOST }} << 'EOF'
            set -e
            DEPLOYMENT_PATH="${{ env.EC2_DEPLOYMENT_PATH }}"
            BACKUP_PATH="${DEPLOYMENT_PATH}.backup"
            
            echo "üíæ Creating backup of current deployment..."
            
            # Remove old backup if it exists (with sudo)
            if [ -d "$BACKUP_PATH" ]; then
              echo "üóëÔ∏è  Removing old backup..."
              sudo rm -rf "$BACKUP_PATH"
            fi
            
            # Create backup (with sudo for directory creation, then fix ownership)
            # Use rsync to exclude unnecessary files for faster backup
            if [ -d "$DEPLOYMENT_PATH" ]; then
              echo "üì¶ Copying deployment to backup (excluding large directories)..."
              sudo rsync -a --exclude='node_modules' --exclude='venv' --exclude='__pycache__' --exclude='.git' --exclude='*.pyc' --exclude='.pytest_cache' --exclude='dist' --exclude='build' "$DEPLOYMENT_PATH/" "$BACKUP_PATH/"
              sudo chown -R ubuntu:ubuntu "$BACKUP_PATH"
              echo "‚úÖ Backup created at: $BACKUP_PATH"
            else
              echo "‚ö†Ô∏è  Deployment directory not found, skipping backup"
            fi
          EOF

      - name: Deploy backend to EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ env.EC2_HOST }} << 'EOF'
            set -e
            DEPLOYMENT_PATH="${{ env.EC2_DEPLOYMENT_PATH }}"
            
            echo "üöÄ Starting backend deployment..."
            
            # Navigate to deployment directory
            cd "$DEPLOYMENT_PATH"
            
            # Pull latest code
            echo "üì• Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main
            
            # Update dependencies
            echo "üì¶ Updating Python dependencies..."
            cd backend
            
            # Create venv if it doesn't exist
            if [ ! -d "venv" ]; then
              echo "üêç Creating Python virtual environment..."
              python3 -m venv venv
            fi
            
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # Run database migrations
            echo "üîÑ Running database migrations..."
            python -m app.db.migrations.run_all
            if [ $? -ne 0 ]; then
              echo "‚ùå Database migrations failed"
              exit 1
            fi
            echo "‚úÖ Database migrations completed"
            
            # Restart FastAPI service
            echo "üîÑ Restarting FastAPI service..."
            sudo systemctl restart fastapi
            
            # Wait a moment for service to start
            sleep 3
            
            echo "‚úÖ Backend deployment completed"
          EOF

      - name: Health check
        run: |
          echo "üîç Starting health check..."
          MAX_ATTEMPTS=12
          WAIT_SECONDS=5
          API_URL="${{ env.API_BASE_URL }}/api/health"
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "üì° Health check attempt $i/$MAX_ATTEMPTS..."
            
            if response=$(curl -s -f "$API_URL" 2>/dev/null); then
              if echo "$response" | grep -q '"status"[[:space:]]*:[[:space:]]*"healthy"'; then
                echo "‚úÖ Health check passed!"
                echo "Response: $response"
                exit 0
              else
                echo "‚ö†Ô∏è  Service responding but not healthy yet"
                echo "Response: $response"
              fi
            else
              echo "‚è≥ Service not responding yet (attempt $i/$MAX_ATTEMPTS)"
            fi
            
            if [ $i -lt $MAX_ATTEMPTS ]; then
              sleep $WAIT_SECONDS
            fi
          done
          
          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          echo "üîÑ Deployment failed, initiating rollback..."
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ env.EC2_HOST }} << 'EOF'
            set -e
            DEPLOYMENT_PATH="${{ env.EC2_DEPLOYMENT_PATH }}"
            BACKUP_PATH="${DEPLOYMENT_PATH}.backup"
            
            echo "üîÑ Starting rollback process..."
            
            # Check if backup exists
            if [ ! -d "$BACKUP_PATH" ]; then
              echo "‚ùå Backup directory not found: $BACKUP_PATH"
              echo "‚ö†Ô∏è  Cannot perform rollback"
              exit 1
            fi
            
            echo "‚úÖ Backup found, proceeding with rollback..."
            
            # Stop FastAPI service
            echo "üõë Stopping FastAPI service..."
            sudo systemctl stop fastapi || echo "‚ö†Ô∏è  Service may already be stopped"
            
            # Remove current deployment (preserve .env file)
            ENV_BACKUP="/tmp/ad-mint-ai-env-backup"
            if [ -d "$DEPLOYMENT_PATH" ]; then
              echo "üóëÔ∏è  Removing current deployment..."
              # Backup .env if it exists (to temp location before removing directory)
              if [ -f "$DEPLOYMENT_PATH/backend/.env" ]; then
                echo "üíæ Backing up current .env file..."
                sudo cp "$DEPLOYMENT_PATH/backend/.env" "$ENV_BACKUP"
              fi
              
              # Remove deployment directory
              sudo rm -rf "$DEPLOYMENT_PATH"
            fi
            
            # Restore from backup
            echo "üì¶ Restoring from backup..."
            sudo rsync -a "$BACKUP_PATH/" "$DEPLOYMENT_PATH/"
            
            # Restore .env file if we backed it up (from temp location)
            if [ -f "$ENV_BACKUP" ]; then
              echo "üìù Restoring .env file..."
              sudo cp "$ENV_BACKUP" "$DEPLOYMENT_PATH/backend/.env"
              sudo rm "$ENV_BACKUP"
              sudo chmod 600 "$DEPLOYMENT_PATH/backend/.env"
            fi
            
            # Ensure proper permissions
            echo "üîê Setting permissions..."
            sudo chown -R ubuntu:ubuntu "$DEPLOYMENT_PATH"
            
            # Recreate virtual environment if it doesn't exist (since we excluded it from backup)
            if [ ! -d "$DEPLOYMENT_PATH/backend/venv" ]; then
              echo "üêç Recreating Python virtual environment..."
              cd "$DEPLOYMENT_PATH/backend"
              python3 -m venv venv
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
              deactivate
            fi
            
            # Restart FastAPI service
            echo "üöÄ Restarting FastAPI service..."
            sudo systemctl start fastapi
            
            # Wait a moment for service to start
            sleep 5
            
            # Check service status
            if sudo systemctl is-active --quiet fastapi; then
              echo "‚úÖ FastAPI service is running"
            else
              echo "‚ö†Ô∏è  FastAPI service may not be running properly"
            fi
            
            echo "‚úÖ Rollback completed successfully"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/ec2_key.pem

      - name: Deployment summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment completed successfully!"
            echo "üåê Frontend: http://${{ env.S3_FRONTEND_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com"
            echo "üîó Backend API: ${{ env.API_BASE_URL }}/api/"
            echo "‚ù§Ô∏è  Health Check: ${{ env.API_BASE_URL }}/api/health"
          else
            echo "‚ùå Deployment failed"
            echo "üîÑ Rollback was attempted if backup was available"
          fi
